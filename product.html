<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>商品详情</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <header class="header">
        <div class="container">
            <nav class="navbar">
                <a href="/" class="nav-logo">CloudCard</a>
                <ul class="nav-menu">
                    <li><a href="/" class="nav-link">首页</a></li>
                    <li><a href="/articles.html" class="nav-link">文章</a></li>
                    <li><a href="/admin/" class="nav-link">登录</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <main class="container section">
        <div class="product-detail-layout">
            <!-- 商品图片 -->
            <div class="product-detail-image">
                <img id="product-image" src="https://placehold.co/600x400/e2e8f0/64748b?text=Loading..." alt="商品图片">
            </div>

            <!-- 商品信息和购买表单 -->
            <div class="product-detail-info">
                <h1 id="product-name">正在加载...</h1>
                <p id="product-price" class="product-price-large"></p>
                <p id="product-description" class="product-description"></p>
                
                <form id="purchase-form">
                    <h3>选择规格</h3>
                    <div id="variants-container" class="variants-container">
                        <p>正在加载规格...</p>
                    </div>
                    <button type="submit" class="button button-primary button-full" disabled>请先选择规格</button>
                </form>
                <p id="error-message" class="error-message"></p>
            </div>
        </div>
    </main>

    <footer class="footer">
        <div class="container">
            <p>&copy; 2025 CloudCard. 保留所有权利。</p>
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const params = new URLSearchParams(window.location.search);
            const productId = params.get('id');

            const productName = document.getElementById('product-name');
            const productDescription = document.getElementById('product-description');
            const productPrice = document.getElementById('product-price');
            const productImage = document.getElementById('product-image');
            const variantsContainer = document.getElementById('variants-container');
            const form = document.getElementById('purchase-form');
            const purchaseButton = form.querySelector('button');
            const errorMessage = document.getElementById('error-message');

            if (!productId) {
                productName.textContent = '错误';
                productDescription.textContent = '未找到商品 ID。';
                return;
            }

            try {
                const response = await fetch(`/api/products/${productId}`);
                if (!response.ok) throw new Error('商品不存在');
                
                const product = await response.json();

                // 填充商品基础信息
                productName.textContent = product.name;
                productDescription.textContent = product.description;
                productPrice.textContent = `￥${product.base_price.toFixed(2)} 起`;
                productImage.src = product.image_url;
                productImage.alt = product.name;
                productImage.onerror = () => { productImage.src = `https://placehold.co/600x400/e2e8f0/64748b?text=${encodeURIComponent(product.name)}`; };

                if (product.variants.length === 0) {
                    variantsContainer.innerHTML = '<p>该商品暂无可用规格。</p>';
                    return;
                }

                variantsContainer.innerHTML = ''; // 清空加载提示
                let selectedVariantId = null;
                let selectedVariantName = '';
                let selectedVariantPrice = 0;

                // 渲染规格
                product.variants.forEach((variant) => {
                    const finalPrice = product.base_price + variant.price_adjustment;
                    const variantId = `variant-${variant.id}`;
                    
                    const div = document.createElement('div');
                    div.className = 'variant-option';
                    
                    const input = document.createElement('input');
                    input.type = 'radio';
                    input.name = 'variant';
                    input.id = variantId;
                    input.value = variant.id;
                    
                    const label = document.createElement('label');
                    label.htmlFor = variantId;
                    label.textContent = `${variant.name} - ￥${finalPrice.toFixed(2)}`;
                    
                    div.appendChild(input);
                    div.appendChild(label);
                    variantsContainer.appendChild(div);

                    // 监听选择
                    input.addEventListener('change', () => {
                        selectedVariantId = variant.id;
                        selectedVariantName = variant.name;
                        selectedVariantPrice = finalPrice;
                        
                        productPrice.textContent = `￥${selectedVariantPrice.toFixed(2)}`;
                        purchaseButton.textContent = `立即购买 (${selectedVariantName})`;
                        purchaseButton.disabled = false;
                        errorMessage.textContent = '';
                    });
                });

                // 提交表单
                form.addEventListener('submit', (e) => {
                    e.preventDefault();
                    if (selectedVariantId) {
                        // 跳转到支付页面
                        window.location.href = `/pay.html?variant_id=${selectedVariantId}`;
                    } else {
                        errorMessage.textContent = '请选择一个规格。';
                    }
                });

            } catch (error) {
                console.error('Error fetching product details:', error);
                productName.textContent = '加载失败';
                errorMessage.textContent = '无法加载商品详情。' + error.message;
            }
        });
    </script>
</body>
</html>
