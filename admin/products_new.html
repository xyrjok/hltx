<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>新建商品 - CloudCard</title>
    <link rel="stylesheet" href="/static/bootstrap.min.css"/>
    <link rel="stylesheet" href="/static/all.min.css"/>
    <link rel="stylesheet" href="/admin/admin.css">
    <style>
        /* 强制规格卡片中的 input 宽度 */
        .variant-card .form-control {
            min-width: 80px;
        }
        /* 确保删除按钮垂直居中 */
        .variant-card .row {
            align-items: center;
        }
    </style>
</head>
<body>
    <div class="admin-layout">
        <nav class="sidebar">
            <h2>CloudCard</h2>
            <ul>
                <li><a href="/admin/dashboard.html"><i class="fas fa-tachometer-alt"></i> 仪表盘</a></li>
                <li><a href="/admin/orders.html"><i class="fas fa-shopping-cart"></i> 订单列表</a></li>
                <li class="submenu-title"><a href="#"><i class="fas fa-box-open"></i> 商品管理</a></li>
                <li class="submenu-item"><a href="/admin/categories.html">商品分类</a></li>
                <li class="submenu-item"><a href="/admin/products.html">商品列表</a></li>
                <li class="submenu-item active"><a href="/admin/products_new.html">新建商品</a></li>
                <li class="submenu-title"><a href="#"><i class="fas fa-key"></i> 卡密管理</a></li>
                <li class="submenu-item"><a href="/admin/cards_list.html">卡密列表</a></li>
                <li class="submenu-item"><a href="/admin/cards_import.html">导入/导出卡密</a></li>
                <li><a href="/admin/payment_settings.html"><i class="fas fa-money-check-alt"></i> 支付设置</a></li>
                <li><a href="/admin/articles.html"><i class="fas fa-file-alt"></i> 文章管理</a></li>
                <li><a href="/admin/config.html"><i class="fas fa-cogs"></i> 配置</a></li>
            </ul>
            <button id="logout-button" class="button button-secondary">
                <i class="fas fa-sign-out-alt"></i> 退出登录
            </button>
        </nav>
        
        <main class="main-content">
            <h1 id="page-title">新建商品</h1>

            <form id="product-form">
                <div class="row">
                    <div class="col-lg-8">
                        <div class="admin-card p-3 mb-4">
                            <div class="mb-3">
                                <label for="name" class="form-label">商品名称</label>
                                <input type="text" class="form-control" id="name" required>
                            </div>
                            <div class="mb-3">
                                <label for="description" class="form-label">商品描述</label>
                                <textarea class="form-control" id="description" rows="10"></textarea>
                            </div>
                        </div>

                        <div class="admin-card p-3 mb-4">
                            <h4>商品规格</h4>
                            <p>您可以在此为商品添加多种规格。每个规格都可以设置独立的批发价和自选加价。</p>
                            <div class="row g-2 d-none d-lg-flex mb-2">
                                <div class="col-md-2"><label class="form-label">规格名称</label></div>
                                <div class="col-md-1"><label class="form-label">字体颜色</label></div>
                                <div class="col-md-2"><label class="form-label">图片链接</label></div>
                                <div class="col-md-1"><label class="form-label">售价</label></div>
                                <div class="col-md-2"><label class="form-label">批发价配置</label></div>
                                <div class="col-md-1"><label class="form-label">库存</label></div>
                                <div class="col-md-1"><label class="form-label">自选加价</label></div>
                                <div class="col-md-1"><label class="form-label">销量</label></div>
                                <div class="col-md-1"></div>
                            </div>
                            
                            <div id="variants-container">
                                </div>
                            
                            <button type="button" class="btn btn-secondary mt-3" id="add-variant-btn">
                                <i class="fas fa-plus"></i> 添加新规格
                            </button>
                        </div>
                    </div>

                    <div class="col-lg-4">
                        <div class="admin-card p-3 mb-4">
                            <h4><i class="fas fa-cogs"></i> 商品配置</h4>
                            <div class="mb-3">
                                <label for="category-id" class="form-label">所属分类</label>
                                <select class="form-select" id="category-id" required>
                                    <option value="">请选择分类...</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="image_url" class="form-label">商品图片 URL</label>
                                <input type="text" class="form-control" id="image_url" placeholder="https://example.com/image.png">
                            </div>
                            <div class="mb-3">
                                <label for="sort_weight" class="form-label">排序权重</label>
                                <input type="number" class="form-control" id="sort_weight" value="0">
                                <small class="form-text">数字越大，排序越靠前。</small>
                            </div>
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="is_active" checked>
                                <label class="form-check-label" for="is_active">立即上架</label>
                            </div>
                        </div>

                        <div class="admin-card p-3 mb-4">
                            <h4><i class="fas fa-tags"></i> SEO 信息</h4>
                            <div class="mb-3">
                                <label for="short_description" class="form-label">简短描述</label>
                                <textarea class="form-control" id="short_description" rows="3"></textarea>
                            </div>
                            <div class="mb-3">
                                <label for="keywords" class="form-label">关键词 (逗号分隔)</label>
                                <input type="text" class="form-control" id="keywords">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="admin-toolbar-sticky">
                    <button type="submit" class="btn btn-primary" id="save-product-btn">
                        <i class="fas fa-save"></i> 保存商品
                    </button>
                    <div id="form-message" class="mt-2" style="display: none;"></div>
                </div>
            </form>
        </main>
    </div>

    <template id="variant-card-template">
        <div class="card variant-card mb-2">
            <div class="card-body p-2">
                <div class="row g-2">
                    <div class="col-lg-2">
                        <label class="form-label d-lg-none">规格名称</label>
                        <input type="text" class="form-control variant-name" placeholder="规格名称" required>
                    </div>
                    <div class="col-lg-1">
                        <label class="form-label d-lg-none">字体颜色</label>
                        <input type="text" class="form-control variant-color-code" placeholder="例如: #FFFFFF">
                    </div>
                    <div class="col-lg-2">
                        <label class="form-label d-lg-none">图片链接</label>
                        <input type="text" class="form-control variant-image-url" placeholder="http://.../img.png">
                    </div>
                    <div class="col-lg-1">
                        <label class="form-label d-lg-none">售价</label>
...
                        <input type="number" class="form-control variant-stock" placeholder="库存" readonly>
                    </div>
                    <div class="col-lg-1">
                        <label class="form-label d-lg-none">自选加价</label>
                        <input type="number" class="form-control variant-addon-price" placeholder="自选加价" step="0.01">
                        </div>
                    <div class="col-lg-1">
                        <label class="form-label d-lg-none">销量</label>
                        <input type="number" class="form-control variant-sales" placeholder="销量" readonly>
                    </div>
                    <div class="col-lg-1 text-end">
                         <label class="form-label d-lg-none">&nbsp;</label>
                        <button type="button" class="btn btn-danger btn-sm remove-variant-btn">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </template>
    
    <script src="/static/bootstrap.bundle.min.js"></script>
    <script src="/static/tinymce/tinymce.min.js"></script>
    <script src="/admin/auth.js"></script>
    <script src="/admin/admin.js"></script> 
    <script>
        // (*** 下方的 JavaScript 和我们上次的一样，无需改动 ***)
        
        const variantsContainer = document.getElementById('variants-container');
        const addVariantBtn = document.getElementById('add-variant-btn');
        const productForm = document.getElementById('product-form');
        const saveBtn = document.getElementById('save-product-btn');
        const formMessage = document.getElementById('form-message');
        const pageTitle = document.getElementById('page-title');
        
        let existingProductId = null;

        tinymce.init({
            selector: '#description',
            plugins: 'lists link image media codesample wordcount',
            toolbar: 'undo redo | blocks | bold italic | alignleft aligncenter alignright | indent outdent | bullist numlist | link image media codesample',
            language: 'zh_CN',
            skin: 'oxide',
            content_css: '/static/bootstrap.min.css'
        });

        // 1. 添加一个新规格卡片
        function addVariantCard(variant = {}) {
            const template = document.getElementById('variant-card-template');
            const clone = template.content.cloneNode(true);
            const variantCard = clone.querySelector('.variant-card');

            if (variant.id) {
                variantCard.dataset.id = variant.id;
            }
            
            variantCard.querySelector('.variant-name').value = variant.name || '';
            variantCard.querySelector('.variant-color-code').value = variant.color_code || '';
            variantCard.querySelector('.variant-image-url').value = variant.image_url || '';
            variantCard.querySelector('.variant-price').value = variant.price || variant.base_price || '';
            variantCard.querySelector('.variant-addon-price').value = variant.addon_price || '';
            variantCard.querySelector('.variant-stock').value = variant.stock_count || variant.stock || 0;
            variantCard.querySelector('.variant-sales').value = variant.sales || 0;
            variantCard.querySelector('.variant-wholesale-config').value = variant.wholesale_config || '';

            variantCard.querySelector('.remove-variant-btn').addEventListener('click', () => {
                if (variantsContainer.querySelectorAll('.variant-card').length > 1) {
                    variantCard.remove();
                } else {
                    alert('至少需要保留一个商品规格。');
                }
            });

            variantsContainer.appendChild(clone);
        }

        // 2. 加载分类列表
        async function loadCategories() {
            const select = document.getElementById('category-id');
            try {
                const categories = await adminFetch('/api/admin/categories');
                if (categories && categories.length > 0) {
                    categories.forEach(cat => {
                        const option = document.createElement('option');
                        option.value = cat.id;
                        option.textContent = cat.name;
                        select.appendChild(option);
                    });
                } else {
                    select.innerHTML = '<option value="">未找到分类</option>';
                }
            } catch (error) {
                console.error('Error loading categories:', error);
                select.innerHTML = '<option value="">加载分类失败</option>';
            }
        }

        // 3. (用于编辑) 加载现有商品数据
        async function loadProductData(id) {
            pageTitle.textContent = `编辑商品 (ID: ${id})`;
            try {
                const product = await adminFetch('/api/admin/products/' + id);
                populateForm(product);
            } catch (error) {
                showMessage(`加载商品失败: ${error.message}`, 'danger');
            }
        }

        // 4. (用于编辑) 填充表单
        function populateForm(product) {
            document.getElementById('name').value = product.name;
            tinymce.get('description').setContent(product.description || '');
            document.getElementById('category-id').value = product.category_id;
            document.getElementById('image_url').value = product.image_url;
            document.getElementById('sort_weight').value = product.sort_weight;
            document.getElementById('is_active').checked = product.is_active;
            document.getElementById('short_description').value = product.short_description;
            document.getElementById('keywords').value = product.keywords;

            variantsContainer.innerHTML = ''; 
            if (product.variants && product.variants.length > 0) {
                product.variants.forEach(variant => addVariantCard(variant));
            } else {
                addVariantCard();
            }
        }

        // 5. 收集规格数据
        function collectVariantsData() {
            const variantCards = variantsContainer.querySelectorAll('.variant-card');
            const variants = [];
            let isValid = true;

            variantCards.forEach(variantCard => {
                const name = variantCard.querySelector('.variant-name').value;
                const price = variantCard.querySelector('.variant-price').value;

                if (!name || !price) {
                    isValid = false;
                }
                
                const variantId = variantCard.dataset.id ? parseInt(variantCard.dataset.id, 10) : undefined;

                variants.push({
                    id: variantId, 
                    name: name,
                    color_code: variantCard.querySelector('.variant-color-code').value || '',
                    image_url: variantCard.querySelector('.variant-image-url').value || '',
                    price: price,
                    addon_price: variantCard.querySelector('.variant-addon-price').value || 0,
                    stock: variantCard.querySelector('.variant-stock').value || 0, // (这个 stock 字段是冗余的)
                    sales: variantCard.querySelector('.variant-sales').value || 0,
                    wholesale_config: variantCard.querySelector('.variant-wholesale-config').value || ''
                });
            });

            if (!isValid) {
                throw new Error('所有规格的 "规格名称" 和 "价格" 都是必填项。');
            }
            if (variants.length === 0) {
                throw new Error('商品必须至少有一个规格。');
            }
            return variants;
        }

        // 6. 提交表单
        async function handleSubmit(event) {
            event.preventDefault();
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 正在保存...';

            try {
                await tinymce.triggerSave();
                const variants = collectVariantsData();
                
                const productData = {
                    name: document.getElementById('name').value,
                    description: document.getElementById('description').value,
                    category_id: document.getElementById('category-id').value,
                    image_url: document.getElementById('image_url').value,
                    sort_weight: document.getElementById('sort_weight').value || 0,
                    is_active: document.getElementById('is_active').checked,
                    short_description: document.getElementById('short_description').value,
                    keywords: document.getElementById('keywords').value,
                    variants: variants 
                };

                let response;
                let method = existingProductId ? 'PUT' : 'POST';
                let url = existingProductId 
                    ? `/api/admin/products/${existingProductId}` 
                    : '/api/admin/products';

                response = await adminFetch(url, {
                    method: method,
                    body: productData
                });

                if (response.ok) {
                    const result = await response.json();
                    showMessage('商品保存成功！', 'success');
                    if (!existingProductId) {
                        window.location.search = `?id=${result.id}`;
                    } else {
                        // (编辑模式) 重新加载数据，以显示同步后的库存和ID
                        loadProductData(existingProductId);
                    }
                } else {
                    const error = await response.json();
                    throw new Error(error.message || '保存失败');
                }

            } catch (error) {
                showMessage(`保存失败: ${error.message}`, 'danger');
            } finally {
                saveBtn.disabled = false;
                saveBtn.innerHTML = '<i class="fas fa-save"></i> 保存商品';
            }
        }
        
        // 7. 显示消息
        function showMessage(message, type = 'danger') {
            formMessage.textContent = message;
            formMessage.className = `alert alert-${type}`;
            formMessage.style.display = 'block';
            window.scrollTo(0, document.body.scrollHeight);
        }

        // --- 页面初始化 ---
        document.addEventListener('DOMContentLoaded', () => {
            loadCategories();

            const urlParams = new URLSearchParams(window.location.search);
            existingProductId = urlParams.get('id');

            if (existingProductId) {
                loadProductData(existingProductId);
            } else {
                addVariantCard();
            }

            addVariantBtn.addEventListener('click', () => addVariantCard());
            productForm.addEventListener('submit', handleSubmit);
        });
    </script>
</body>
</html>
