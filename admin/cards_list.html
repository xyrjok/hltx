<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>卡密列表 - CloudCard</title>
	<link rel="stylesheet" href="/static/bootstrap.min.css"/>
	<link rel="stylesheet" href="/static/all.min.css"/>
    <link rel="stylesheet" href="/admin/admin.css">
</head>
<body>
    <div class="admin-layout">
        <nav class="sidebar">
            <h2>CloudCard</h2>
            <ul>
                <li><a href="/admin/dashboard.html"><i class="fas fa-tachometer-alt"></i> 仪表盘</a></li>
                <li><a href="/admin/orders.html"><i class="fas fa-shopping-cart"></i> 订单列表</a></li>
                <li class="submenu-title"><a href="#"><i class="fas fa-box-open"></i> 商品管理</a></li>
                <li class="submenu-item"><a href="/admin/categories.html">商品分类</a></li>
                <li class="submenu-item"><a href="/admin/products.html">商品列表</a></li>
                <li class="submenu-item"><a href="/admin/products_new.html">新建商品</a></li>
                <li class="submenu-title"><a href="#"><i class="fas fa-key"></i> 卡密管理</a></li>
                <li class="submenu-item active"><a href="/admin/cards_list.html">卡密列表</a></li>
                <li class="submenu-item"><a href="/admin/cards_import.html">导入/导出卡密</a></li>
                <li><a href="/admin/payment_settings.html"><i class="fas fa-money-check-alt"></i> 支付设置</a></li>
                <li><a href="/admin/articles.html"><i class="fas fa-file-alt"></i> 文章管理</a></li>
                <li><a href="/admin/config.html"><i class="fas fa-cogs"></i> 配置</a></li>
            </ul>
            <button id="logout-button" class="button button-secondary">
                <i class="fas fa-sign-out-alt"></i> 退出登录
            </button>
        </nav>
        
        <main class="main-content">
            <h1>卡密列表 <small class="text-muted fs-5">(查看所有卡密)</small></h1>

            <div class="admin-card p-3">
                <div class="admin-toolbar mb-3">
                    <div class="input-group search-input">
                        <span class="input-group-text"><i class="fas fa-search"></i></span>
                        <input type="text" id="card-search" class="form-control" placeholder="搜索卡密或预选信息..." onkeyup="filterCards()">
                    </div>

                    <div class="select-group">
                        <label for="filter-product" class="form-label mb-0 me-2">商品:</label>
                        <select id="filter-product" class="form-select" onchange="filterCards()">
                            <option value="">所有商品</option>
                            <option value="1">商品A</option>
                            <option value="2">商品B</option>
                        </select>
                    </div>

                    <div class="select-group">
                        <label for="filter-status" class="form-label mb-0 me-2">状态:</label>
                        <select id="filter-status" class="form-select" onchange="filterCards()">
                            <option value="">所有状态</option>
                            <option value="0">未使用</option>
                            <option value="1">已使用</option>
                        </select>
                    </div>
                    
                    <button type="button" class="btn btn-primary me-2" data-bs-toggle="modal" data-bs-target="#addCardModal">
                        <i class="fas fa-plus"></i> 新增卡密
                    </button>

                    <button id="bulk-edit-btn" class="btn button-info" onclick="openBulkEditModal()" disabled>
                        <i class="fas fa-edit"></i> 批量编辑
                    </button>

                    <button id="bulk-delete-btn" class="btn button-danger" onclick="bulkDeleteCards()" disabled>
                        <i class="fas fa-trash"></i> 批量删除 (<span id="selected-count">0</span>)
                    </button>
                </div>

                <div class="table-responsive">
                    <table class="admin-table table table table-hover">
                        <thead>
                            <tr>
                                <th style="width: 1%;">
                                    <input type="checkbox" id="select-all" class="form-check-input" onclick="toggleSelectAll()">
                                </th>
                                <th>卡密内容 <i class="fas fa-sort-alpha-down"></i></th>
                                <th>预选信息</th>
                                <th>关联商品 (规格ID)</th>
                                <th>状态 <i class="fas fa-sort"></i></th>
                                <th>导入时间</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="card-list-body">
                            <tr><td colspan="7" class="text-center">正在加载卡密...</td></tr>
                        </tbody>
                    </table>
                </div>
                
                <p id="list-message" class="mt-3" style="display: none;"></p>
            </div>
        </main>
    </div>

    <div class="modal fade" tabindex="-1" id="bulkEditModal" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">批量编辑卡密</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>您已选择了 <strong id="bulk-modal-count">0</strong> 条卡密。请选择要批量修改的字段：</p>
                    <form id="bulk-edit-form">
                        <div class="form-group">
                            <label for="bulk-product-id">修改关联商品 (规格ID)</label>
                            <input type="text" id="bulk-product-id" class="form-control" placeholder="留空则不修改">
                        </div>
                        <div class="form-group">
                            <label for="bulk-is-used">修改使用状态</label>
                            <select id="bulk-is-used" class="form-select">
                                <option value="">不修改</option>
                                <option value="0">0 (未使用)</option>
                                <option value="1">1 (已使用)</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="processBulkEdit()">执行批量编辑</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal fade" id="addCardModal" tabindex="-1" aria-labelledby="addCardModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addCardModalLabel">新增卡密</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addCardForm">
                        
                        <div class="mb-3">
                            <label for="productSelect" class="form-label">所属商品</label>
                            <select class="form-select" id="productSelect" required>
                                <option value="">正在加载商品...</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="variantSelect" class="form-label">所属商品规格</label>
                            <select class="form-select" id="variantSelect" required disabled>
                                <option value="">请先选择商品</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="cardSecret" class="form-label">卡密 (含预选信息)</label>
                            <textarea class="form-control" id="cardSecret" rows="3" required placeholder="粘贴卡密，格式: 卡密信息#[预选信息]#"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="isSold" class="form-label">是否售出</label>
                            <select class="form-select" id="isSold">
                                <option value="0" selected>否</option>
                                <option value="1">是</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="saveCardBtn">保存</button>
                </div>
            </div>
        </div>
    </div>
    
	<script src="/static/bootstrap.bundle.min.js"></script>
    <script src="/admin/auth.js"></script>
    <script src="/admin/admin.js"></script> 
	<script>
        // 退出登录和 token 获取逻辑已移动到 utils.js

        const cardListBodyEl = document.getElementById('card-list-body');
        const listMessageEl = document.getElementById('list-message');
        const bulkDeleteBtn = document.getElementById('bulk-delete-btn');
        const bulkEditBtn = document.getElementById('bulk-edit-btn');
        const selectedCountEl = document.getElementById('selected-count');
        
        let cardsData = []; // 存储原始卡密数据

        // 状态映射
        const statusMap = {
            0: '<span class="badge bg-success"><i class="fas fa-circle"></i> 未使用</span>',
            1: '<span class="badge bg-danger"><i class="fas fa-check-circle"></i> 已使用</span>'
        };

        // 1. 加载现有卡密
        async function loadCards() {
            listMessageEl.style.display = 'none';
            cardListBodyEl.innerHTML = '<tr><td colspan="7" class="text-center">正在加载卡密...</td></tr>';
            document.getElementById('select-all').checked = false;
            updateBulkButtons();

            try {
                cardsData = await adminFetch('/api/admin/cards'); 

                if (cardsData.length > 0 && cardsData[0].card_id === undefined) {
                    cardsData = cardsData.map((card, index) => ({
                        ...card,
                        card_id: card.card_id || (index + 1),
                        card_key: card.card_key || `ABC-123-${1000 + index}`,
                        preset_info: card.preset_info || null, 
                        variant_id: card.variant_id || (Math.floor(Math.random() * 2) + 1),
                        product_name: card.product_name || `商品 ${card.variant_id === 1 ? 'A' : 'B'}`,
                        is_used: card.is_used || (Math.random() > 0.8 ? 1 : 0),
                        created_at: card.created_at || new Date(Date.now() - Math.random() * 86400000 * 30).toISOString(),
                    }));
                }
                
                applyFiltersAndSort();

            } catch (error) {
                cardListBodyEl.innerHTML = `<tr><td colspan="7" class="text-center text-danger"><i class="fas fa-exclamation-triangle"></i> ${error.message}</td></tr>`;
            }
        }

        // START: 逻辑修改 - 
        
        // (新) 函数1: 加载商品列表 (第一个下拉菜单)
        async function loadProductsForModal() {
            const productSelect = document.getElementById('productSelect');
            const variantSelect = document.getElementById('variantSelect');
            
            productSelect.innerHTML = '<option value="">正在加载商品...</option>';
            variantSelect.innerHTML = '<option value="">请先选择商品</option>';
            variantSelect.disabled = true;
            
            try {
                const products = await adminFetch('/api/admin/products');
                if (!products || products.length === 0) {
                    productSelect.innerHTML = '<option value="">未找到商品</option>';
                    return;
                }
                
                productSelect.innerHTML = '<option value="">请选择一个商品</option>';
                products.forEach(product => {
                    const option = document.createElement('option');
                    option.value = product.id;
                    option.textContent = product.name;
                    productSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading products for modal:', error);
                productSelect.innerHTML = `<option value="">加载失败: ${error.message}</option>`;
            }
        }

        // (新) 函数2: 处理商品选择变化 (加载第二个下拉菜单)
        async function handleProductChange() {
            const productSelect = document.getElementById('productSelect');
            const variantSelect = document.getElementById('variantSelect');
            const productId = productSelect.value;

            if (!productId) {
                variantSelect.innerHTML = '<option value="">请先选择商品</option>';
                variantSelect.disabled = true;
                return;
            }

            variantSelect.disabled = false;
            variantSelect.innerHTML = '<option value="">正在加载规格...</option>';

            try {
                // (这依赖 _worker.js 中 GET /api/admin/products/:id 的正确实现)
                const productDetail = await adminFetch(`/api/admin/products/${productId}`);
                
                if (productDetail && productDetail.variants && productDetail.variants.length > 0) {
                    variantSelect.innerHTML = '<option value="">请选择一个规格</option>';
                    productDetail.variants.forEach(variant => {
                        if (variant.id) { // 必须有 variant.id
                            const option = document.createElement('option');
                            option.value = variant.id;
                            option.textContent = variant.name;
                            variantSelect.appendChild(option);
                        }
                    });
                } else {
                    variantSelect.innerHTML = '<option value="">此商品无可用规格</option>';
                }
            } catch (error) {
                console.error('Error loading variants:', error);
                variantSelect.innerHTML = `<option value="">加载规格失败</option>`;
            }
        }
        
        // (原) 函数3: 保存卡密 (此函数无需大改)
        async function saveNewCard() {
            // 只需确保 variantId 是从 #variantSelect 读取的
            const variantId = document.getElementById('variantSelect').value; 
            const secret = document.getElementById('cardSecret').value.trim();
            const isSold = document.getElementById('isSold').value;

            if (!variantId) {
                alert('请选择一个商品规格');
                return;
            }
            if (!secret) {
                alert('卡密内容不能为空');
                return;
            }

            try {
                const response = await adminFetch('/api/admin/cards', {
                    method: 'POST',
                    body: { 
                        variant_id: parseInt(variantId, 10),
                        secret: secret, // 后端负责解析 (卡密信息#[预选信息]#)
                        is_sold: parseInt(isSold, 10)
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    alert(`新增卡密成功: ${result.count} 张`);
                    
                    const modalEl = document.getElementById('addCardModal');
                    const modal = bootstrap.Modal.getInstance(modalEl);
                    modal.hide();
                    
                    document.getElementById('addCardForm').reset();
                    loadCards(); // 刷新卡密列表
                } else {
                    const error = await response.json();
                    alert(`保存失败: ${error.message}`);
                }
            } catch (error) {
                console.error('Error saving new card:', error);
                alert(`保存失败: ${error.message}`);
            }
        }
        // END: 逻辑修改

        // 2. 显示卡密列表 (包含搜索、排序和过滤逻辑)
        function displayCards(cards, sortValue, searchValue) {
            const productFilter = document.getElementById('filter-product').value;
            const statusFilter = document.getElementById('filter-status').value;
            const searchLower = searchValue.toLowerCase();
            
            let filteredCards = cards.filter(card => {
                const matchesSearch = String(card.card_key).toLowerCase().includes(searchLower) ||
                                      (card.preset_info && String(card.preset_info).toLowerCase().includes(searchLower));
                
                const matchesProduct = !productFilter || String(card.variant_id) === productFilter;
                const matchesStatus = statusFilter === "" || String(card.is_used) === statusFilter;
                return matchesSearch && matchesProduct && matchesStatus;
            });

            filteredCards.sort((a, b) => {
                return a.card_key.localeCompare(b.card_key);
            });

            cardListBodyEl.innerHTML = '';
            
            if (filteredCards.length === 0) {
                cardListBodyEl.innerHTML = `<tr><td colspan="7" class="text-center">未找到匹配的卡密。</td></tr>`;
                return;
            }

            filteredCards.forEach(card => {
                const row = document.createElement('tr');
                
                const presetHtml = card.preset_info 
                    ? `<small><pre style="margin: 0; white-space: pre-wrap; word-break: break-all;">${card.preset_info}</pre></small>` 
                    : '<span class="text-muted">无</span>';
                
                row.innerHTML = `
                    <td>
                        <input type="checkbox" class="form-check-input card-checkbox" data-id="${card.card_id}" onchange="updateBulkButtons()">
                    </td>
                    <td><strong>${card.card_key}</strong></td>
                    <td>${presetHtml}</td>
                    <td>${card.product_name} <span class="badge bg-info">${card.variant_id}</span></td>
                    <td>${statusMap[card.is_used] || '未知'}</td>
                    <td>${new Date(card.created_at).toLocaleDateString()}</td>
                    <td class="table-actions">
                        <button class="btn button-danger button-sm" onclick="deleteCard(${card.card_id})">
                            <i class="fas fa-trash"></i> 删除
                        </button>
                    </td>
                `;
                cardListBodyEl.appendChild(row);
            });
        }
        
        // 3. 搜索/过滤触发器
        function applyFiltersAndSort() {
            const searchInput = document.getElementById('card-search').value;
            displayCards(cardsData, '', searchInput); 
        }
        const filterCards = applyFiltersAndSort;

        // 4. 单个删除卡密
        async function deleteCard(cardId) {
            if (!confirm(`确定要删除 ID 为 ${cardId} 的卡密吗？`)) return;

            try {
                await adminFetch(`/api/admin/cards/${cardId}`, {
                    method: 'DELETE',
                });
                
                listMessageEl.textContent = `卡密 ${cardId} 删除成功 (模拟)`;
                listMessageEl.className = 'mt-3 text-success';
                listMessageEl.style.display = 'block';

                await loadCards(); // 重新加载列表
                
            } catch (error) {
                listMessageEl.textContent = `删除失败: ${error.message}`;
                listMessageEl.className = 'mt-3 text-danger';
                listMessageEl.style.display = 'block';
            }
        }
        
        // 5. 批量操作 UI
        function toggleSelectAll() {
            const isChecked = document.getElementById('select-all').checked;
            document.querySelectorAll('.card-checkbox').forEach(checkbox => {
                checkbox.checked = isChecked;
            });
            updateBulkButtons();
        }

        function updateBulkButtons() {
            const selected = document.querySelectorAll('.card-checkbox:checked').length;
            selectedCountEl.textContent = selected;
            bulkDeleteBtn.disabled = selected === 0;
            bulkEditBtn.disabled = selected === 0;
        }

        async function bulkDeleteCards() {
            const selectedIds = Array.from(document.querySelectorAll('.card-checkbox:checked'))
                                     .map(checkbox => checkbox.dataset.id);

            if (selectedIds.length === 0) return;
            if (!confirm(`确定要批量删除这 ${selectedIds.length} 个卡密吗？`)) return;

            try {
                listMessageEl.textContent = `成功删除 ${selectedIds.length} 个卡密 (模拟)`;
                listMessageEl.className = 'mt-3 text-success';
                listMessageEl.style.display = 'block';

                await loadCards();
                
            } catch (error) {
                listMessageEl.textContent = `批量删除失败: ${error.message}`;
                listMessageEl.className = 'mt-3 text-danger';
                listMessageEl.style.display = 'block';
            }
        }
        
        // 6. 批量编辑逻辑
        function openBulkEditModal() {
            const selected = document.querySelectorAll('.card-checkbox:checked').length;
            document.getElementById('bulk-modal-count').textContent = selected;
            document.getElementById('bulk-edit-form').reset(); // 重置表单

            const bulkEditModal = new bootstrap.Modal(document.getElementById('bulkEditModal'));
            bulkEditModal.show();
        }
        
        async function processBulkEdit() {
            const selectedIds = Array.from(document.querySelectorAll('.card-checkbox:checked'))
                                     .map(checkbox => checkbox.dataset.id);
            const productId = document.getElementById('bulk-product-id').value;
            const isUsed = document.getElementById('bulk-is-used').value;
            
            if (!productId && !isUsed) {
                alert('请至少填写一个要修改的字段！');
                return;
            }
            
            const updates = {
                ids: selectedIds,
                variant_id: productId || undefined,
                is_used: isUsed === "" ? undefined : parseInt(isUsed)
            };
            
            const bulkEditModalEl = document.getElementById('bulkEditModal');
            const modal = bootstrap.Modal.getInstance(bulkEditModalEl) || new bootstrap.Modal(bulkEditModalEl);

            try {
                modal.hide();
                listMessageEl.textContent = `成功对 ${selectedIds.length} 个卡密执行批量编辑 (模拟)`;
                listMessageEl.className = 'mt-3 text-success';
                listMessageEl.style.display = 'block';

                await loadCards();
            } catch (error) {
                modal.hide();
                listMessageEl.textContent = `批量编辑失败: ${error.message}`;
                listMessageEl.className = 'mt-3 text-danger';
                listMessageEl.style.display = 'block';
            }
        }


        // 页面加载时运行
        
        // START: 添加事件监听 (更新)
        const addCardModalEl = document.getElementById('addCardModal');
        addCardModalEl.addEventListener('show.bs.modal', function (event) {
            // 每次打开时重新加载商品列表
            loadProductsForModal(); 
        });
        
        // 监听第一个下拉菜单的变化
        document.getElementById('productSelect').addEventListener('change', handleProductChange);
        
        // 监听保存按钮点击
        document.getElementById('saveCardBtn').addEventListener('click', saveNewCard);
        // END: 添加事件监听

        loadCards();
    </script>
</body>
</html>
