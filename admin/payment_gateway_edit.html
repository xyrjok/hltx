<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>编辑支付通道 - CloudCard</title>
    
	<link rel="stylesheet" href="/static/bootstrap.min.css"/>
	<link rel="stylesheet" href="/static/all.min.css"/>   
    <link rel="stylesheet" href="/admin/admin.css">
</head>
<body>
    <div class="admin-layout">
        <nav class="sidebar">
            <h2>CloudCard</h2>
            <ul>
                <li><a href="/admin/dashboard.html"><i class="fas fa-tachometer-alt"></i> 仪表盘</a></li>
                <li><a href="/admin/orders.html"><i class="fas fa-shopping-cart"></i> 订单列表</a></li>
                <li class="submenu-title"><a href="#"><i class="fas fa-box-open"></i> 商品管理</a></li>
                <li class="submenu-item"><a href="/admin/categories.html">商品分类</a></li>
                <li class="submenu-item"><a href="/admin/products.html">商品列表</a></li>
                <li class="submenu-item"><a href="/admin/products_new.html">新建商品</a></li>
                <li class="submenu-title"><a href="#"><i class="fas fa-key"></i> 卡密管理</a></li>
                <li class="submenu-item"><a href="/admin/cards_list.html">卡密列表</a></li>
                <li class="submenu-item"><a href="/admin/cards_import.html">导入/导出卡密</a></li>
                <li class="active"><a href="/admin/payment_gateways.html"><i class="fas fa-money-check-alt"></i> 支付设置</a></li>
                <li><a href="/admin/articles.html"><i class="fas fa-file-alt"></i> 文章管理</a></li>
                <li><a href="/admin/config.html"><i class="fas fa-cogs"></i> 配置</a></li>
            </ul>
            <button id="logout-button" class="button button-secondary">
                <i class="fas fa-sign-out-alt"></i> 退出登录
            </button>
        </nav>
        
        <main class="main-content">
            <h1>编辑支付通道</h1>
            <p>编辑支付通道的详细信息和凭据。</p>
            
            <div class="admin-card">
                <form id="edit-gateway-form">
                    <input type="hidden" id="gateway_id">
                    
                    <div class="form-group">
                        <label for="name">通道名称</label>
                        <input type="text" class="form-control" id="name" placeholder="例如：官方支付宝" required>
                    </div>

                    <div class="form-group">
                        <label for="interface_type">接口类型</label>
                        <select class="form-control" id="interface_type">
                            <option value="usdt_gateway">USDT 网关 (自托管)</option>
                            
                            <option value="agg_alipay">真实支付宝 (聚合平台)</option>
                            <option value="agg_wechat">真实微信 (聚合平台)</option>
                            
                            </select>
                        <small class="text-muted">
                            "接口类型" 是一个代码标识符 (例如 `agg_alipay`)，它告诉 `_worker.js` 文件要执行哪段支付逻辑。
                        </small>
                    </div>

                    <div class="form-group">
                        <label for="merchant_id">商户 ID (Merchant ID / URL)</label>
                        <input type="text" class="form-control" id="merchant_id" placeholder="填写您的商户 ID 或网关 URL">
                        <small class="text-muted">
                            对于自托管网关，这可能是 URL。对于聚合支付，这通常是您的商户号。
                        </small>
                    </div>

                    <div class="form-group">
                        <label for="secret_key">密钥 (Secret Key / API Key)</label>
                        <input type="password" class="form-control" id="secret_key" placeholder="如需更新请输入新密钥，否则留空">
                        <small class="text-muted">用于 API 调用的密钥。留空则表示不修改。</small>
                    </div>

                    <div class="form-group">
                        <label for="webhook_secret">Webhook 密钥 (Webhook Secret)</label>
                        <input type="password" class="form-control" id="webhook_secret" placeholder="如需更新请输入新密钥，否则留空">
                        <small class="text-muted">用于验证支付回调 (Webhook) 的密钥。留空则表示不修改。</small>
                    </div>

                    <div class="form-group form-check">
                        <input type="checkbox" class="form-check-input" id="is_active">
                        <label class="form-check-label" for="is_active">激活此支付通道</label>
                    </div>

                    <button type="submit" class="button button-primary">
                        <i class="fas fa-save"></i> 保存更改
                    </button>
                    <a href="/admin/payment_gateways.html" class="button button-secondary">
                        取消
                    </a>
                </form>
            </div>
        </main>
    </div>
    
	<script src="/static/bootstrap.bundle.min.js"></script>
    <script src="/admin/auth.js"></script>
    <script src="/admin/admin.js"></script>

    <script>
        // 特定于此页面的 JS
        document.addEventListener('DOMContentLoaded', () => {
            const form = document.getElementById('edit-gateway-form');
            const gatewayIdInput = document.getElementById('gateway_id');
            const nameInput = document.getElementById('name');
            const interfaceTypeInput = document.getElementById('interface_type');
            const merchantIdInput = document.getElementById('merchant_id');
            const secretKeyInput = document.getElementById('secret_key');
            const webhookSecretInput = document.getElementById('webhook_secret');
            const isActiveInput = document.getElementById('is_active');
            
            const params = new URLSearchParams(window.location.search);
            const gatewayId = params.get('id');

            if (!gatewayId) {
                // 如果没有 ID，这是“新建”模式
                document.querySelector('h1').textContent = '创建新通道';
            } else {
                // 如果有 ID，这是“编辑”模式
                gatewayIdInput.value = gatewayId;
                fetchGatewayDetails(gatewayId);
            }

            async function fetchGatewayDetails(id) {
                try {
                    const response = await fetch(`/api/admin/payment_gateways/${id}`, {
                        headers: { 'Authorization': `Bearer ${adminToken}` }
                    });
                    const data = await handleAuthError(response);
                    
                    if (data && response.ok) {
                        nameInput.value = data.name;
                        interfaceTypeInput.value = data.interface_type;
                        merchantIdInput.value = data.merchant_id;
                        isActiveInput.checked = data.is_active === 1;
                        
                        // 出于安全，密钥字段不会被预填充
                        secretKeyInput.placeholder = "已设置，如需更新请输入新密钥";
                        webhookSecretInput.placeholder = "已设置，如需更新请输入新密钥";
                    } else {
                        throw new Error(data.message || '获取通道详情失败');
                    }
                } catch (error) {
                    showToast('获取详情失败: ' + error.message, 'error');
                }
            }

            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const payload = {
                    name: nameInput.value,
                    interface_type: interfaceTypeInput.value,
                    merchant_id: merchantIdInput.value,
                    is_active: isActiveInput.checked ? 1 : 0,
                    // 只有在用户输入了新值时才发送密钥
                    ...(secretKeyInput.value && { secret_key: secretKeyInput.value }),
                    ...(webhookSecretInput.value && { webhook_secret: webhookSecretInput.value }),
                };

                const url = gatewayId 
                    ? `/api/admin/payment_gateways/${gatewayId}` 
                    : '/api/admin/payment_gateways';
                    
                const method = gatewayId ? 'PUT' : 'POST';

                try {
                    const response = await fetch(url, {
                        method: method,
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${adminToken}`
                        },
                        body: JSON.stringify(payload)
                    });

                    const data = await handleAuthError(response);

                    if (data && response.ok) {
                        showToast(`通道${gatewayId ? '更新' : '创建'}成功!`, 'success');
                        setTimeout(() => {
                            window.location.href = '/admin/payment_gateways.html';
                        }, 1000);
                    } else {
                        throw new Error(data.message || '操作失败');
                    }
                } catch (error) {
                    showToast('操作失败: ' + error.message, 'error');
                }
            });
        });
    </script>
</body>
</html>
