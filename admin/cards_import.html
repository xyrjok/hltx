<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>导入/导出卡密 - CloudCard</title>
    <link rel="stylesheet" href="/static/bootstrap.min.css"/>
    <link rel="stylesheet" href="/static/all.min.css"/>
    <link rel="stylesheet" href="/admin/admin.css">
</head>
<body>
    <div class="admin-layout">
        <nav class="sidebar">
            <h2>CloudCard</h2>
            <ul>
                <li><a href="/admin/dashboard.html"><i class="fas fa-tachometer-alt"></i> 仪表盘</a></li>
                <li><a href="/admin/orders.html"><i class="fas fa-shopping-cart"></i> 订单列表</a></li>
                <li class="submenu-title"><a href="#"><i class="fas fa-box-open"></i> 商品管理</a></li>
                <li class="submenu-item"><a href="/admin/categories.html">商品分类</a></li>
                <li class="submenu-item"><a href="/admin/products.html">商品列表</a></li>
                <li class="submenu-item"><a href="/admin/products_new.html">新建商品</a></li>
                <li class="submenu-title"><a href="#"><i class="fas fa-key"></i> 卡密管理</a></li>
                <li class="submenu-item"><a href="/admin/cards_list.html">卡密列表</a></li>
                <li class="submenu-item active"><a href="/admin/cards_import.html">导入/导出卡密</a></li>
                <li><a href="/admin/payment_settings.html"><i class="fas fa-money-check-alt"></i> 支付设置</a></li>
                <li><a href="/admin/articles.html"><i class="fas fa-file-alt"></i> 文章管理</a></li>
                <li><a href="/admin/config.html"><i class="fas fa-cogs"></i> 配置</a></li>
            </ul>
            <button id="logout-button" class="button button-secondary">
                <i class="fas fa-sign-out-alt"></i> 退出登录
            </button>
        </nav>
        
        <main class="main-content">
            <h1>导入/导出卡密 <small class="text-muted fs-5">(批量管理卡密)</small></h1>

            <div class="admin-card p-3">
                <h3><i class="fas fa-upload"></i> 导入卡密</h3>
                <p>请选择要导入的商品规格，并在下方文本框中粘贴卡密，每行一个。支持新格式：<code>卡密信息#[预选信息]#</code></p>
                <div class="row">
                    <div class="col-md-6">
                        <label for="import-variant-select" class="form-label">选择商品规格</label>
                        <select id="import-variant-select" class="form-select">
                            <option value="">正在加载商品...</option>
                        </select>
                    </div>
                </div>
                
                <div class="row mt-3">
                    <div class="col-12">
                        <label for="card-keys-textarea" class="form-label">卡密列表 (每行一个)</label>
                        <textarea id="card-keys-textarea" class="form-control" rows="10" placeholder="在此处粘贴卡密，每行一个。
示例 (有预选):
大区:神境之地----账号:admin----密码:123456#[大区:神境之地----等级:100]#

示例 (无预选):
AAKvSsfWGnFdngPf5V61wpeAluX35t1a9Xn35qsEQwp32
"></textarea>
                        </div>
                </div>
                
                <button id="import-cards-btn" class="btn btn-primary mt-3">
                    <i class="fas fa-check"></i> 开始导入
                </button>

                <div id="import-result" class="mt-3" style="display: none;"></div>
            </div>
            
            <div class="admin-card p-3 mt-4">
                <h3><i class="fas fa-download"></i> 导出卡密</h3>
                <p>选择条件以导出卡密数据为 CSV 文件。</p>
                <button class="btn btn-secondary" onclick="alert('导出功能尚未实现')">
                    <i class="fas fa-file-csv"></i> 导出所有卡密
                </button>
            </div>
        </main>
    </div>
    
    <script src="/static/bootstrap.bundle.min.js"></script>
    <script src="/admin/auth.js"></script>
    <script src="/admin/admin.js"></script> 
    <script>
        // (*** 此处的 JavaScript 脚本内容无需任何修改 ***)

        // 此页面的JS逻辑
        const importSelectEl = document.getElementById('import-variant-select');
        const importTextareaEl = document.getElementById('card-keys-textarea');
        const importBtn = document.getElementById('import-cards-btn');
        const importResultEl = document.getElementById('import-result');

        // 1. 加载商品规格到下拉菜单
        async function loadVariantsForImport() {
            importSelectEl.innerHTML = '<option value="">正在加载商品...</option>';
            try {
                // (这是一个N+1查询，和 cards_list 页面一样)
                const products = await adminFetch('/api/admin/products');
                if (!products || products.length === 0) {
                    importSelectEl.innerHTML = '<option value="">未找到商品</option>';
                    return;
                }

                let allVariants = [];
                for (const product of products) {
                    const productDetail = await adminFetch(`/api/admin/products/${product.id}`);
                    if (productDetail && productDetail.variants && productDetail.variants.length > 0) {
                        productDetail.variants.forEach(variant => {
                            if (variant.id) { // 必须有 variant.id
                                allVariants.push({
                                    id: variant.id, 
                                    name: `${product.name} - ${variant.name}`
                                });
                            }
                        });
                    }
                }
                
                importSelectEl.innerHTML = '<option value="">请选择一个商品规格</option>';
                allVariants.forEach(variant => {
                    const option = document.createElement('option');
                    option.value = variant.id;
                    option.textContent = variant.name;
                    importSelectEl.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading variants:', error);
                importSelectEl.innerHTML = '<option value="">加载失败</option>';
            }
        }

        // 2. 处理导入按钮点击
        async function handleImportCards() {
            const variantId = importSelectEl.value;
            const keysString = importTextareaEl.value.trim();
            
            if (!variantId) {
                alert('请选择一个商品规格！');
                return;
            }
            if (!keysString) {
                alert('请粘贴要导入的卡密！');
                return;
            }

            const keys = keysString.split('\n').filter(k => k.trim().length > 0);
            
            if (keys.length === 0) {
                alert('未找到有效的卡密行。');
                return;
            }

            importBtn.disabled = true;
            importBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 正在导入...';
            importResultEl.style.display = 'none';
            importResultEl.className = 'mt-3';

            try {
                // 后端 /api/admin/cards/import 期待 { variant_id: 123, keys: ["key1", "key2"] }
                // 我们在 _worker.js 中修改了此API，使其能解析新格式
                const response = await adminFetch('/api/admin/cards/import', {
                    method: 'POST',
                    body: {
                        variant_id: parseInt(variantId),
                        keys: keys // keys 是一个字符串数组 (包含新格式的字符串)
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    importResultEl.className = 'mt-3 alert alert-success';
                    importResultEl.textContent = `导入成功！总共 ${keys.length} 行，成功添加 ${result.added_count} 张卡密。`;
                    importResultEl.style.display = 'block';
                    importTextareaEl.value = ''; // 清空
                } else {
                    const error = await response.json();
                    throw new Error(error.message || '导入失败');
                }

            } catch (error) {
                console.error('Import error:', error);
                importResultEl.className = 'mt-3 alert alert-danger';
                importResultEl.textContent = `导入失败: ${error.message}`;
                importResultEl.style.display = 'block';
            } finally {
                importBtn.disabled = false;
                importBtn.innerHTML = '<i class="fas fa-check"></i> 开始导入';
            }
        }

        // 页面加载时
        document.addEventListener('DOMContentLoaded', () => {
            loadVariantsForImport();
            importBtn.addEventListener('click', handleImportCards);
        });
    </script>
</body>
</html>
