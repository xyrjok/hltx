<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ”¯ä»˜é¡µé¢</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>

    <header class="header">
        <div class="container">
            <nav class="navbar">
                <a href="/" class="nav-logo">CloudCard</a>
            </nav>
        </div>
    </header>

    <main class="container section">
        <div class="payment-container">
            <h1 class="section-title">å®‰å…¨æ”¯ä»˜</h1>

            <div id="loading-order" class="payment-status">
                <div class="spinner"></div>
                <h2>æ­£åœ¨åˆ›å»ºè®¢å•...</h2>
                <p>è¯·ç¨å€™ï¼Œæ­£åœ¨ä¸ºæ‚¨ç”Ÿæˆæ”¯ä»˜ä¿¡æ¯ã€‚</p>
            </div>

            <div id="payment-processing" class="payment-status" style="display: none;">
                <h2 id="order-product-name">å•†å“åç§°</h2>
                <p id="order-amount" class="order-amount">ï¿¥--.--</p>
                <div id="qr-code-container">
                    <img id="qr-code-img" alt="æ”¯ä»˜äºŒç»´ç ">
                </div>
                <h3>è¯·æ‰«ç æ”¯ä»˜</h3>
                <p id="payment-status-message">è®¢å•å°†åœ¨æ”¯ä»˜æˆåŠŸåè‡ªåŠ¨å®Œæˆã€‚</p>
                <div class="spinner"></div>
            </div>

            <div id="payment-success" class="payment-status" style="display: none;">
                <h2>ğŸ‰ æ”¯ä»˜æˆåŠŸï¼</h2>
                <p>æ„Ÿè°¢æ‚¨çš„è´­ä¹°ï¼Œæ‚¨çš„å¡å¯†ä¿¡æ¯å¦‚ä¸‹ï¼š</p>
                <div id="delivered-card" class="card-secret">
                    </div>
                <button id="copy-card-button" class="button button-secondary" style="margin-top: 1rem;">å¤åˆ¶å¡å¯†</button>
                <a href="/" class="button button-primary" style="margin-top: 0.5rem;">è¿”å›é¦–é¡µ</a>
            </div>

            <div id="payment-error" class="payment-status" style="display: none;">
                <h2>æ”¯ä»˜å¤±è´¥</h2>
                <p id="error-message-content">åˆ›å»ºè®¢å•å¤±è´¥ï¼Œè¯·é‡è¯•ã€‚</p>
                <a href="/" class="button button-secondary">è¿”å›é¦–é¡µ</a>
            </div>
        </div>
    </main>

    <footer class="footer">
        <div class="container">
            <p>&copy; 2025 CloudCard. ä¿ç•™æ‰€æœ‰æƒåˆ©ã€‚</p>
        </div>
    </footer>

    <script>
        // UI çŠ¶æ€ç®¡ç†
        const loadingOrderEl = document.getElementById('loading-order');
        const paymentProcessingEl = document.getElementById('payment-processing');
        const paymentSuccessEl = document.getElementById('payment-success');
        const paymentErrorEl = document.getElementById('payment-error');

        function showStatus(status) {
            loadingOrderEl.style.display = 'none';
            paymentProcessingEl.style.display = 'none';
            paymentSuccessEl.style.display = 'none';
            paymentErrorEl.style.display = 'none';

            if (status === 'loading') loadingOrderEl.style.display = 'block';
            if (status === 'processing') paymentProcessingEl.style.display = 'block';
            if (status === 'success') paymentSuccessEl.style.display = 'block';
            if (status === 'error') paymentErrorEl.style.display = 'block';
        }

        document.addEventListener('DOMContentLoaded', () => {
            const params = new URLSearchParams(window.location.search);
            // [ä¿®æ”¹] ä¹Ÿå…è®¸é€šè¿‡ order_id è¿”å›é¡µé¢
            const variantId = params.get('variant_id');
            const orderId = params.get('order_id');

            if (variantId) {
                createOrder(variantId);
            } else if (orderId) {
                // å¦‚æœæ˜¯ä»æ”¯ä»˜ç½‘å…³ return_url è¿”å›çš„
                showStatus('processing');
                // ç«‹å³å¼€å§‹è½®è¯¢
                pollOrderStatus(orderId);
                // (å¯ä»¥å°è¯•ä» /api/orders/:id è·å–å•†å“åç§°å’Œé‡‘é¢ï¼Œä½†ä¸ºç®€å•èµ·è§ï¼Œä»…è½®è¯¢)
            } else {
                showError('æœªæ‰¾åˆ°å•†å“æˆ–è®¢å•ä¿¡æ¯ï¼Œæ— æ³•æ”¯ä»˜ã€‚');
                return;
            }
            
            // å¤åˆ¶æŒ‰é’®é€»è¾‘
            const copyButton = document.getElementById('copy-card-button');
            copyButton.addEventListener('click', () => {
                const cardText = document.getElementById('delivered-card').textContent;
                navigator.clipboard.writeText(cardText).then(() => {
                    copyButton.textContent = 'å·²å¤åˆ¶!';
                    setTimeout(() => { copyButton.textContent = 'å¤åˆ¶å¡å¯†'; }, 2000);
                }).catch(err => {
                    console.error('å¤åˆ¶å¤±è´¥: ', err);
                    copyButton.textContent = 'å¤åˆ¶å¤±è´¥';
                });
            });
        });

        function showError(message) {
            showStatus('error');
            document.getElementById('error-message-content').textContent = message;
        }

        // 1. åˆ›å»ºè®¢å•
        async function createOrder(variantId) {
            showStatus('loading');
            try {
                const response = await fetch('/api/orders', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ variant_id: variantId })
                });
                
                const order = await response.json();

                if (!response.ok) {
                    throw new Error(order.message || 'åˆ›å»ºè®¢å•å¤±è´¥');
                }

                showStatus('processing');
                document.getElementById('order-product-name').textContent = order.product_name;
                document.getElementById('order-amount').textContent = `ï¿¥${order.total_amount.toFixed(2)}`;
                
                // [ä¿®æ”¹] å¤„ç† payment_url (æ¥è‡ª Stripe æˆ–èšåˆæ”¯ä»˜)
                if (order.payment_url) {
                    // å¦‚æœæ˜¯äºŒç»´ç å›¾ç‰‡ URL (æˆ– base64 data URI)
                    document.getElementById('qr-code-img').src = order.payment_url;
                } else if (order.qr_code_content) {
                    // å¦‚æœæ˜¯äºŒç»´ç å†…å®¹ (éœ€è¦ä¸€ä¸ªåº“æ¥ç”Ÿæˆï¼Œè¿™é‡Œä»…ä½œæ¼”ç¤º)
                    // å‡è®¾ qr_code_content æ˜¯ä¸€ä¸ª data URI
                    document.getElementById('qr-code-img').src = order.qr_code_content;
                    console.log("æ­£åœ¨ä½¿ç”¨ qr_code_content");
                } else {
                    showError('æœªèƒ½è·å–æ”¯ä»˜ä¿¡æ¯ï¼Œè¯·é‡è¯•ã€‚');
                    return;
                }
                
                // 2. å¼€å§‹è½®è¯¢è®¢å•çŠ¶æ€ (æ­¤å‡½æ•°ä¿æŒä¸å˜)
                pollOrderStatus(order.order_id);

            } catch (error) {
                console.error('Create order error:', error);
                showError(error.message);
            }
        }

        // 2. è½®è¯¢è®¢å•çŠ¶æ€ (ä¿æŒä¸å˜)
        function pollOrderStatus(orderId) {
            // (ç¡®ä¿ä¸ä¼šé‡å¤å¯åŠ¨è½®è¯¢)
            if (window.pollingInterval) {
                clearInterval(window.pollingInterval);
            }
            
            const poll = async () => {
                try {
                    const response = await fetch(`/api/orders/${orderId}`);
                    if (!response.ok) return; // ç»§ç»­è½®è¯¢

                    const order = await response.json();

                    if (order.status === 'paid') {
                        // æ”¯ä»˜æˆåŠŸ
                        clearInterval(window.pollingInterval);
                        window.pollingInterval = null;
                        
                        showStatus('success');
                        document.getElementById('delivered-card').textContent = order.delivered_card;
                        
                        if (order.preset_info) {
                            const presetEl = document.createElement('div');
                            presetEl.className = 'card-preset-info';
                            presetEl.textContent = `é¢„è®¾ä¿¡æ¯: ${order.preset_info}`;
                            document.getElementById('delivered-card').after(presetEl);
                        }
                        
                    } else if (order.status === 'failed') {
                        // æ”¯ä»˜å¤±è´¥
                        clearInterval(window.pollingInterval);
                        window.pollingInterval = null;
                        showError('è®¢å•å·²å…³é—­æˆ–æ”¯ä»˜å¤±è´¥ã€‚');
                    }
                    // å¦‚æœæ˜¯ 'pending'ï¼Œåˆ™ä¸åšä»»ä½•äº‹ï¼Œç»§ç»­è½®è¯¢
                } catch (error) {
                    console.error('Poll status error:', error);
                    // å‘ç”Ÿç½‘ç»œé”™è¯¯æ—¶ä¹Ÿç»§ç»­è½®è¯¢
                }
            };
            
            poll(); // ç«‹å³æ‰§è¡Œä¸€æ¬¡
            window.pollingInterval = setInterval(poll, 3000); // æ¯ 3 ç§’æŸ¥è¯¢ä¸€æ¬¡
        }
    </script>
</body>
</html>
