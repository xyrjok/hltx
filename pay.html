<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ”¯ä»˜é¡µé¢</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>

    <header class="header">
        <div class="container">
            <nav class="navbar">
                <a href="/" class="nav-logo">CloudCard</a>
            </nav>
        </div>
    </header>

    <main class="container section">
        <div class="payment-container">
            <h1 class="section-title">å®‰å…¨æ”¯ä»˜</h1>

            <!-- è®¢å•åˆ›å»ºä¸­ -->
            <div id="loading-order" class="payment-status">
                <div class="spinner"></div>
                <h2>æ­£åœ¨åˆ›å»ºè®¢å•...</h2>
                <p>è¯·ç¨å€™ï¼Œæ­£åœ¨ä¸ºæ‚¨ç”Ÿæˆæ”¯ä»˜ä¿¡æ¯ã€‚</p>
            </div>

            <!-- æ”¯ä»˜ä¸­ -->
            <div id="payment-processing" class="payment-status" style="display: none;">
                <h2 id="order-product-name">å•†å“åç§°</h2>
                <p id="order-amount" class="order-amount">ï¿¥--.--</p>
                <div id="qr-code-container">
                    <img id="qr-code-img" src="https://placehold.co/200x200/ffffff/000000?text=QR+Code" alt="æ”¯ä»˜äºŒç»´ç ">
                </div>
                <h3>è¯·æ‰«ç æ”¯ä»˜</h3>
                <p id="payment-status-message">è®¢å•å°†åœ¨æ”¯ä»˜æˆåŠŸåè‡ªåŠ¨å®Œæˆã€‚</p>
                <div class="spinner"></div>
            </div>

            <!-- æ”¯ä»˜æˆåŠŸ -->
            <div id="payment-success" class="payment-status" style="display: none;">
                <h2>ğŸ‰ æ”¯ä»˜æˆåŠŸï¼</h2>
                <p>æ„Ÿè°¢æ‚¨çš„è´­ä¹°ï¼Œæ‚¨çš„å¡å¯†ä¿¡æ¯å¦‚ä¸‹ï¼š</p>
                <div id="delivered-card" class="card-secret">
                    <!-- å¡å¯†å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ -->
                </div>
                <a href="/" class="button button-primary">è¿”å›é¦–é¡µ</a>
            </div>

            <!-- æ”¯ä»˜å¤±è´¥ -->
            <div id="payment-error" class="payment-status" style="display: none;">
                <h2>æ”¯ä»˜å¤±è´¥</h2>
                <p id="error-message-content">åˆ›å»ºè®¢å•å¤±è´¥ï¼Œè¯·é‡è¯•ã€‚</p>
                <a href="/" class="button button-secondary">è¿”å›é¦–é¡µ</a>
            </div>
        </div>
    </main>

    <footer class="footer">
        <div class="container">
            <p>&copy; 2025 CloudCard. ä¿ç•™æ‰€æœ‰æƒåˆ©ã€‚</p>
        </div>
    </footer>

    <script>
        // UI çŠ¶æ€ç®¡ç†
        const loadingOrderEl = document.getElementById('loading-order');
        const paymentProcessingEl = document.getElementById('payment-processing');
        const paymentSuccessEl = document.getElementById('payment-success');
        const paymentErrorEl = document.getElementById('payment-error');

        function showStatus(status) {
            loadingOrderEl.style.display = 'none';
            paymentProcessingEl.style.display = 'none';
            paymentSuccessEl.style.display = 'none';
            paymentErrorEl.style.display = 'none';

            if (status === 'loading') loadingOrderEl.style.display = 'block';
            if (status === 'processing') paymentProcessingEl.style.display = 'block';
            if (status === 'success') paymentSuccessEl.style.display = 'block';
            if (status === 'error') paymentErrorEl.style.display = 'block';
        }

        document.addEventListener('DOMContentLoaded', () => {
            const params = new URLSearchParams(window.location.search);
            const variantId = params.get('variant_id');

            if (!variantId) {
                showError('æœªæ‰¾åˆ°å•†å“è§„æ ¼ï¼Œæ— æ³•åˆ›å»ºè®¢å•ã€‚');
                return;
            }
            
            createOrder(variantId);
        });

        function showError(message) {
            showStatus('error');
            document.getElementById('error-message-content').textContent = message;
        }

        // 1. åˆ›å»ºè®¢å•
        async function createOrder(variantId) {
            showStatus('loading');
            try {
                const response = await fetch('/api/orders', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ variant_id: variantId })
                });

                if (!response.ok) {
                    throw new Error('åˆ›å»ºè®¢å•å¤±è´¥');
                }

                const order = await response.json();
                
                // æ˜¾ç¤ºæ”¯ä»˜ä¿¡æ¯
                showStatus('processing');
                document.getElementById('order-product-name').textContent = order.product_name;
                document.getElementById('order-amount').textContent = `ï¿¥${order.total_amount.toFixed(2)}`;
                
                // åœ¨æ¨¡æ‹Ÿ API ä¸­ï¼Œqr_code_url åªæ˜¯ä¸€ä¸ªå ä½ç¬¦
                // åœ¨çœŸå® API ä¸­ï¼Œè¿™é‡Œä¼šæ˜¯çœŸå®çš„äºŒç»´ç æ•°æ®æˆ– URL
                if(order.qr_code_url) {
                    document.getElementById('qr-code-img').src = order.qr_code_url;
                }
                
                // 2. å¼€å§‹è½®è¯¢è®¢å•çŠ¶æ€
                pollOrderStatus(order.order_id);

            } catch (error) {
                console.error('Create order error:', error);
                showError(error.message);
            }
        }

        // 2. è½®è¯¢è®¢å•çŠ¶æ€
        function pollOrderStatus(orderId) {
            const interval = setInterval(async () => {
                try {
                    const response = await fetch(`/api/orders/${orderId}`);
                    if (!response.ok) return; // ç»§ç»­è½®è¯¢

                    const order = await response.json();

                    if (order.status === 'paid') {
                        // æ”¯ä»˜æˆåŠŸ
                        clearInterval(interval);
                        showStatus('success');
                        document.getElementById('delivered-card').textContent = order.delivered_card;
                    } else if (order.status === 'failed') {
                        // æ”¯ä»˜å¤±è´¥
                        clearInterval(interval);
                        showError('è®¢å•å·²å…³é—­æˆ–æ”¯ä»˜å¤±è´¥ã€‚');
                    }
                    // å¦‚æœæ˜¯ 'pending'ï¼Œåˆ™ä¸åšä»»ä½•äº‹ï¼Œç»§ç»­è½®è¯¢
                } catch (error) {
                    console.error('Poll status error:', error);
                    // å‘ç”Ÿç½‘ç»œé”™è¯¯æ—¶ç»§ç»­è½®è¯¢
                }
            }, 3000); // æ¯ 3 ç§’æŸ¥è¯¢ä¸€æ¬¡
        }
    </script>
</body>
</html>
